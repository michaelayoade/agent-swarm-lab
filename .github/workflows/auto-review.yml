name: Auto Review Agent PRs

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

jobs:
  auto-review:
    if: startsWith(github.head_ref, 'agent/')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > /tmp/pr-diff.txt
          DIFF_SIZE=$(wc -l < /tmp/pr-diff.txt)
          echo "diff_size=$DIFF_SIZE" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Review with MiniMax M2.5
        if: steps.diff.outputs.diff_size != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          if [[ -z "$OPENROUTER_API_KEY" ]]; then
            echo "âš ï¸ OPENROUTER_API_KEY not set â€” skipping auto-review"
            exit 0
          fi

          # Safely read diff â€” truncate and sanitize for JSON
          DIFF=$(head -3000 /tmp/pr-diff.txt)

          # Build request payload via jq (handles escaping properly)
          PAYLOAD=$(jq -n \
            --arg diff "$DIFF" \
            --arg title "$PR_TITLE" \
            '{
              model: "minimax/minimax-m2.5",
              messages: [{
                role: "user",
                content: ("Review this PR titled: " + $title + "\n\nCheck for:\n1) Correctness\n2) Security issues (hardcoded secrets, injection, path traversal)\n3) Performance\n4) Verdict: approve or changes-needed\n\nKeep under 400 words.\n\nDiff:\n" + $diff)
              }],
              temperature: 0.2,
              max_tokens: 1500
            }')

          RESPONSE=$(curl -s --max-time 60 \
            "https://openrouter.ai/api/v1/chat/completions" \
            -H "Authorization: Bearer ${OPENROUTER_API_KEY}" \
            -H "Content-Type: application/json" \
            -H "X-Title: seabone-auto-review" \
            -d "$PAYLOAD")

          REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

          if [[ -z "$REVIEW" ]]; then
            ERROR=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"')
            echo "âš ï¸ Review API failed: $ERROR"
            exit 0
          fi

          # Post comment using a temp file to avoid shell escaping issues
          cat > /tmp/review-body.md << MDEOF
          ## ðŸ¤– Seabone Automated Review

          $REVIEW

          ---
          *Automated review by Seabone Agent Swarm (MiniMax M2.5 via OpenRouter)*
          MDEOF

          gh pr comment "$PR_NUMBER" --body-file /tmp/review-body.md
